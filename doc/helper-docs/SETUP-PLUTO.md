# Pluto

## OVERVIEW

- Please see http://pluto-compiler.sourceforge.net.

- **This forked copy is from the commit `001cb3767`** which is published on Dec 2, 2023, just after the release of `v0.12.0` on Nov 18, 2023. Pluto use this version name as `0.12.0-2-g001cb37` inside `lib/version.h` (this file autogenerated in compile time).

- This package includes both the tool pluto and libpluto. The `pluto` tool is a source-to-source transformer meant to be run via the polycc script, `libpluto` provides a thread-safe library interface.

## LICENSE

Pluto and libpluto are available under the MIT LICENSE. Please see the file [`LICENSE`](LICENSE) in the top-level directory for more details. And all modifications and additions made in this forked copy is under [`LICENSE_ADDITIONAL`](LICENSE_ADDITIONAL).


## PREREQUISITES

- Ubuntu 20.04LTS is tested.

- In order to use the development version from Pluto's git repository, automatic build system tools, including `autoconf`, `automake`, and `libtool` are needed.

- LLVM/Clang 14.x (14.x recommended, 11.x, 12.x tested to work as well), along with its development/header files, is needed for the pet submodule. For this forked copy, `LLVM/Clang 16.0.6` is also tested successfully.

### Installing Dev dependencies

**Idea:**
- General build tools `build-essential` (contains [multiple packages](https://packages.ubuntu.com/focal/build-essential) `g++`, `gcc`, `make`, `libc6-dev`, `dpkg-dev`)
- Automatic build tools including `autoconf`, `automake`, and `libtool`.
- `libgmp3-dev` that is required by `cloog-isl` lib.
- `flex` and `bison` for `clan` that Pluto depends on.
- `texinfo`, `texlive`, `texlive-latex-extra`, `texlive-science` used to generate some docs.

**What + How to install:**
- General dev dependencies:
```sh
sudo apt-get install -y build-essential flex bison xutils-dev zlib1g-dev libglu1-mesa-dev
```

- Pluto specific dependencies:
```sh
sudo apt-get install -y libgmp3-dev automake autoconf libtool libtool-bin pkg-config
```

- To avoid errors for generating PDF docs from `cloog-isl` (Check [Issue 98](https://github.com/bondhugula/pluto/issues/98) )
```sh
sudo apt-get install -y texinfo texlive texlive-latex-extra texlive-science
```


### Handling `LLVM/Clang` dependency

- **`Clang` should be built (not installed with `apt-get install`)**. Because we consider that you might have other `Clang` versions in your machine.

- We will be passing path of `Clang` using the `--with-clang-prefix=$CLANG_BUILD_PATH` in pluto's `configure` command.

- Make sure of that, the `Clang` lib path is added to your `LD_LIBRARY_PATH` after your build the `Clang`.

- **Clone `Clang 16.0.6` `git clone -b release/16.x --depth 1 https://github.com/llvm/llvm-project.git llvm-16-src-build`**

- **Build Clang with `clang` + `clang++` (faster)**. Clone the `llvm-16.0.6`, then use following

```sh
mkdir -p build installation
cd build/
echo $PWD
cmake   \
    -G Ninja    \
    -S ../llvm  \
    -B .    \
    -DCMAKE_BUILD_TYPE=Release      \
    -DCMAKE_INSTALL_PREFIX=../installation  \
    -DLLVM_ENABLE_ASSERTIONS=ON     \
    -DLLVM_ENABLE_PROJECTS="mlir;clang;lldb;lld" \
    -DLLVM_INSTALL_UTILS=ON     \
    -DLLVM_ENABLE_LLD=ON    \
    -DCMAKE_C_COMPILER=clang    \
    -DCMAKE_CXX_COMPILER=clang++    \
    -DLLVM_PARALLEL_LINK_JOBS=1     \
    -DLLVM_TARGETS_TO_BUILD="Native"

cmake --build . --target check-mlir
ninja install
```

- **Build Clang with `gcc` + `g++` (slower)**.
```sh
mkdir -p build installation
cd build/

echo $PWD

cmake   \
    -G Ninja    \
    -S ../llvm  \
    -B .    \
    -DCMAKE_BUILD_TYPE=Release      \
    -DCMAKE_INSTALL_PREFIX=../installation  \
    -DLLVM_ENABLE_ASSERTIONS=ON     \
    -DLLVM_ENABLE_PROJECTS="mlir;clang;lldb;lld" \
    -DLLVM_INSTALL_UTILS=ON     \
    -DLLVM_ENABLE_LLD=OFF    \
    -DCMAKE_C_COMPILER=gcc    \
    -DCMAKE_CXX_COMPILER=g++    \
    -DLLVM_PARALLEL_LINK_JOBS=0     \
    -DLLVM_TARGETS_TO_BUILD="Native"

cmake --build . --target check-mlir
ninja install
```



- **If `Clang 16` is configured in your `~/.bashrc` or `~/.profile` like following**

```sh
export LLVM_FOLDER_NAME="llvm-16-src-build"
export YOUR_LLVM_PROJECT_CLONE_PATH="/abs/path/to/$LLVM_FOLDER_NAME"
export LLVM_PROJECT_ROOT=$YOUR_LLVM_PROJECT_CLONE_PATH
export LLVM_INSTALLATION_ROOT=$LLVM_PROJECT_ROOT/installation

export LLVM_CONFIG="$LLVM_INSTALLATION_ROOT/bin/llvm-config"
export LLVM_AND_CLANG_BIN_PATH="$LLVM_INSTALLATION_ROOT/bin"
export LLVM_AND_CLANG_LIB_PATH="$LLVM_INSTALLATION_ROOT/lib"
export LLVM_AND_CLANG_INCLUDE_PATH="$LLVM_INSTALLATION_ROOT/include"
export LD_LIBRARY_PATH=$LLVM_AND_CLANG_LIB_PATH${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
export PATH=$LLVM_AND_CLANG_BIN_PATH${PATH:+:${PATH}}
```

- **If you already have another `Clang` configured in your `~/.bashrc` or `~/.profile`**
Check the build shell script for pluto.


## Installing Pluto

### Clone Pluto

- Here the `--recursive` is used to clone also all the `submodules` (i.e. `openscop`, `cloog-isl`, etc.)
```sh
git clone --recursive https://github.com/pal-stdr/pluto-forked.git pluto-with-llvm-16
```

- If you want to clone pluto from the original source

```sh
git clone https://github.com/bondhugula/pluto.git
git checkout 001cb3767

# For loading other libs (cloog-isl, openscop, etc.) nested inside pluto
git submodule update --init
```



### Run the `autogen.sh` to generate `configure` script for each of the submodule

```sh
./autogen.sh
```



### Collect your `--with-clang-prefix=` path for Pluto

Considering the first example `Clang` setup in `~/.profile`, let's assume, the path is `/path/to/your/llvm-16-src-build/installation` or `/path/to/your/llvm-16-src-build/build`.



### Prepare the following `shell` script for installing Pluto

- We assume, you have chosen the forked copy for cloning. The following `shell` can be found here []()

- Please run `build-pluto-with-llvm.sh` from the root of Pluto.

**How this shell works?**
1. It checks if you want to do `configure + make` or only `make`. This options are handy if you donot change your respective `configure.ac` and `Makefile.am` from different libs.
2. While `make` runs, it builds in separate `build/` dir in the pluto root. Keeps the code clean. You can change the dir name/path.
3. `make install` ensures you have the final build assets in separate `installation/` dir w.r.t pluto root pointed by `--prefix` path in `configure` command. You can change the dir name/path.
4. `pet` lib inside pluto expects `Clang`. The `build` or `prefix` path of `Clang` should be passed in `LLVM_FOR_PET_INSTALLATION_ROOT` shell var in the script. **SUPER MANDATORY**.

```sh
#!/bin/bash

# IF YOU WANT TO BUILD ONLY, SET IT TO 0
# IF YOU WANT TO CONFIGURE + BUILD, THEN SET IT TO 1
WANT_TO_CONFIGURE_AND_BUILD=1


# DONOT CHANGE IT.
# If you set "WANT_TO_CONFIGURE_AND_BUILD" to "1", by default "WANT_TO_BUILD_ONLY" will be set to "1"
WANT_TO_BUILD_ONLY=$([ $WANT_TO_CONFIGURE_AND_BUILD -eq 0 ] && echo 1 || echo 0)




# Setup the Clang dependency ENV vars for pet (MANDATORY)
# "LLVM_FOR_PET_INSTALLATION_ROOT" set this to LLVM 16 build or installation path
LLVM_FOR_PET_INSTALLATION_ROOT=/path/to/your/llvm-16-src-build/installation

# If you already have another Clang version in your machine, you need to keep active this part.
# Or even if you don't want to change your ~/.bashrc or ~/.profile for "Clang" build setup, you can keep them activated too. Or comment it out.
LLVM_FOR_PET_LIB_PATH=$LLVM_FOR_PET_INSTALLATION_ROOT/lib
LLVM_FOR_PET_BIN_PATH=$LLVM_FOR_PET_INSTALLATION_ROOT/bin
export LD_LIBRARY_PATH=$LLVM_FOR_PET_LIB_PATH${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
export PATH=$LLVM_FOR_PET_BIN_PATH${PATH:+:${PATH}}




# Name of the folder where you want to build
# This keeps the Pluto src tree much clean
BUILD_DIR="build/"


# Name of the folder, Where you want to install the bins
# By default, this will be passed as "../configure --prefix=pluto/installation ...."
# Name of the dir relative to pluto
INSTALLATION_DIR="installation/"



# Pluto Configure flags
# If you want to use cache, use "-C"
CONFIGURE_FLAGS="--enable-static"



# Set the absolute path for the pluto's "./configure --prefix=$INSTALL_PREFIX" option
# You can change it if you want.
INSTALL_PREFIX=$PWD/$INSTALLATION_DIR


# The LLVM build location
# Change according to your Clang location. Should be absolute path
CLANG_INSTALL_PATH=$LLVM_FOR_PET_INSTALLATION_ROOT





# Handle the build dir
remove_build_dir() {
    if [ -d $BUILD_DIR ]; then
        echo "$BUILD_DIR exists. Deleting..."
        rm -R $BUILD_DIR
        echo "$BUILD_DIR Creating..."
        mkdir -p $BUILD_DIR
    else
        echo "$BUILD_DIR directory does not exist. Creating $BUILD_DIR .."
        mkdir -p $BUILD_DIR
    fi
}


# Handle the install dir
remove_install_dir() {
    if [ -d $INSTALL_PREFIX ]; then
        echo "$INSTALL_PREFIX exists. Deleting..."
        rm -R $INSTALL_PREFIX
        echo "$INSTALL_PREFIX Creating..."
        mkdir -p $INSTALL_PREFIX
    else
        echo "$INSTALL_PREFIX directory does not exist. Creating $INSTALL_PREFIX .."
        mkdir -p $INSTALL_PREFIX
    fi
}



if [ $WANT_TO_BUILD_ONLY -eq 1 ]; then
    echo "You have set 'WANT_TO_BUILD_ONLY' as TRUE."
    echo "$BUILD_DIR will not be deleted."
    echo "$INSTALL_PREFIX will be deleted and created again."
    remove_install_dir
    # Change to build/ dir
    cd $BUILD_DIR
    make -j$(nproc)
    make install
else
    echo "You have set 'WANT_TO_BUILD_ONLY' as FALSE."
    echo "$BUILD_DIR will be deleted and created again."
    echo "$INSTALL_PREFIX will also be deleted and created again."
    remove_build_dir
    remove_install_dir
    # Change to build/ dir
    cd $BUILD_DIR
    ../configure --prefix=$INSTALL_PREFIX --with-clang-prefix=$CLANG_INSTALL_PATH $CONFIGURE_FLAGS
    make -j$(nproc)
    make install
fi


# Key commands that are running

# Change to build/ dir
# cd $BUILD_DIR

# Idea of configure command
# ../configure --prefix=$MY_EXTERNAL_SDD_WORK_DIR/compiler-projects/all-pluto-test/pluto-with-llvm-16/installation --with-clang-prefix=$MY_EXTERNAL_SDD_WORK_DIR/compiler-projects/llvm-src-build/installation --enable-static

# If you want to use cache
# ../configure -C --prefix=$INSTALL_PREFIX --with-clang-prefix=$CLANG_INSTALL_PATH $CONFIGURE_FLAGS

# ../configure --prefix=$INSTALL_PREFIX --with-clang-prefix=$CLANG_INSTALL_PATH $CONFIGURE_FLAGS

# make -j$(nproc)

# make install
```