# cJSON setup as Submodule

**This is already done. So the doc is here for if you want to setup/integrate another lib as submodule with pluto.**

**`how-to-setup-pluto` is the parent git branch of `setup-cJSON` branch.**


## 1. Prepare `cJSON` as a github hosted repository with necessary files.

- You will be needing `configure.ac` & `Makefile.am` prepared in `cJSON`.
- Properly identify the autogenerated config files and list them in `.gitignore`.
- Prepare a separate git branch for submodule purpose.
- For `cJSON`, this could be found at [cJSON-forked](https://github.com/pal-stdr/cJSON-forked/tree/v1.7.17-for-pluto) in `v1.7.17-for-pluto` branch.



## 2. Now add it as a `git` submodule in the parent repo (i.e. `pluto-forked`)

2.1.  Run the following command.
```sh
git submodule add -b v1.7.17-for-pluto --name cJSON https://github.com/pal-stdr/cJSON-forked.git cJSON

# Returns
Cloning into '/path/to/parent-repo/cJSON'...
remote: Enumerating objects: 4120, done.
remote: Counting objects: 100% (81/81), done.
remote: Compressing objects: 100% (61/61), done.
remote: Total 4120 (delta 29), reused 59 (delta 17), pack-reused 4039
Receiving objects: 100% (4120/4120), 2.42 MiB | 5.26 MiB/s, done.
Resolving deltas: 100% (2659/2659), done.
```
**Explanation:**
You will see the `cJSON/` is cloned to your parent repo. There it will automatically create git `index` and the following snippet inside `.gitmodules` file. You don't have to do anything manually. Donot worry about all the dumped files in the `cJSON/` submodule. Those `cJSON/` submodule files will not be tracked by the parent git repo.

```sh
[submodule "cJSON"]
	path = cJSON
	url = https://github.com/pal-stdr/cJSON-forked.git
	branch = v1.7.17-for-pluto
```

To be sure, if you give following command to check

```sh
git status

# Returns
On branch branch_name
Your branch is up to date with 'origin/how-to-setup-pluto'.

Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        modified:   .gitmodules
        new file:   cJSON
```



2.2. Then commit and push the changes in the parent repo. You are done.



## 3. Add following in `autogen.sh` after `clan` setup (typically after `line 44`)

```sh
echo -e "\n*** Running autotools on cJSON ***"
cd cJSON
autoreconf -vi
cd ..
```


## 4. Add following in `configure.ac` after `cloog-isl` setup (typically after `line 356`)

```sh
dnl Custom command to build the cJSON library - PALLAB
dnl Configuring cJSON
echo ""
echo "=========================="
echo "Configuring cJSON"
echo "=========================="
configureopts="--prefix=$prefix --enable-static"
(mkdir -p cJSON
 cd cJSON/
 $REL_SRCDIR_PREFIX/cJSON/configure ${configureopts} ${archopts}
 )
dnl check if cJSON configure had failed
AC_CHECK_FILE([cJSON/Makefile], [], [AC_MSG_ERROR([configure in cJSON/ failed])])
```



## 5. Add `cJSON` dirname at `line 19` in `Makefile.am` like following

**Position of placing `cJSON` is important.**
```sh
SUBDIRS = piplib $(MAY_ISL) lib polylib openscop cloog-isl clan candl pet cJSON tool
```



## 6. Then add the header search `-I` flag path with `pluto_CXXFLAGS` & linker path with `pluto_LDADD` for `cJSON/` for  at `tool/Makefile.am`

6.1. Add the header search `-I` flag path as `-I$(top_srcdir)/` with `pluto_CXXFLAGS`. Typically at `line 47`.

```sh
pluto_CXXFLAGS = $(OPT_FLAGS) $(DEBUG_FLAGS) \
   -DSCOPLIB_INT_T_IS_LONGLONG -DCLOOG_INT_GMP -DPLUTO_OPENCL \
   -I../include \
   -I$(top_srcdir)/include \
   -I$(top_srcdir)/piplib/include \
   -I../clan/include \
   -I$(top_srcdir)/clan/include \
   -I$(top_srcdir)/pet/include \
   $(ISL_INCLUDE) \
   -I../cloog-isl/include \
   -I$(top_srcdir)/cloog-isl/include \
   -I../openscop/include \
   -I$(top_srcdir)/openscop/include \
   -I../candl/include \
   -I$(top_srcdir)/candl/include \
   -I../polylib/include \
   -I$(top_srcdir)/polylib/include \
   -I$(top_srcdir)/lib  \
   -I$(top_srcdir)/  # For cJSON
```

6.2. Add linker path as `../cJSON/libcJSON.la` with `pluto_LDADD`. Typically at `line 64`.

```sh
pluto_LDADD =  \
   ../cloog-isl/libcloog-isl.la \
   ../polylib/libpolylib64.la \
   ../clan/libclan.la \
   ../candl/libcandl.la \
   ../openscop/libosl.la \
   ../lib/libpluto.la \
   $(ISL_LIBADD) \
   ../piplib/libpiplib_dp.la \
   ../pet/libpet.la \
   ../cJSON/libcJSON.la \
   -lm
```



## 7. After adding all of them, run `./autogen.sh`

## 8. Then run the `./build-pluto-with-llvm.sh`



# How to use `cJSON/`

- You just have to use the header call `#include <cJSON/cJSON.h>` or `#include <cJSON/cJSON_Utils.h>` or both anywhere inside any file of the `tool/` dir. Tested with `tool/main.cpp`

- If you want call it like `#include <cJSON.h>`, then change `tool/Makefile.am` file's `pluto_CXXFLAGS` as following

```sh
pluto_CXXFLAGS = $(OPT_FLAGS) $(DEBUG_FLAGS) \
   -DSCOPLIB_INT_T_IS_LONGLONG -DCLOOG_INT_GMP -DPLUTO_OPENCL \
   -I../include \
   -I$(top_srcdir)/include \
   -I$(top_srcdir)/piplib/include \
   -I../clan/include \
   -I$(top_srcdir)/clan/include \
   -I$(top_srcdir)/pet/include \
   $(ISL_INCLUDE) \
   -I../cloog-isl/include \
   -I$(top_srcdir)/cloog-isl/include \
   -I../openscop/include \
   -I$(top_srcdir)/openscop/include \
   -I../candl/include \
   -I$(top_srcdir)/candl/include \
   -I../polylib/include \
   -I$(top_srcdir)/polylib/include \
   -I$(top_srcdir)/lib  \
   -I$(top_srcdir)/cJSON/  # For cJSON
```