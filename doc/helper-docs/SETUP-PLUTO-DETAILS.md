# Pluto

## OVERVIEW

- Please see http://pluto-compiler.sourceforge.net.

- **This forked copy is from the commit `655ca80`** which is published on May 12, 2024, after the release of `v0.12.0` on Nov 18, 2023. Pluto use this version name as `0.12.0-2-g655ca80` inside `lib/version.h` (this file autogenerated in compile time).

- This package includes both the tool pluto and libpluto. The `pluto` tool is a source-to-source transformer meant to be run via the polycc script, `libpluto` provides a thread-safe library interface.

## LICENSE

Pluto and libpluto are available under the MIT LICENSE. Please see the file [`LICENSE`](LICENSE) in the top-level directory for more details. And all modifications and additions made in this forked copy is under [`LICENSE_ADDITIONAL`](LICENSE_ADDITIONAL).


## 1. PREREQUISITES

- Ubuntu 20.04LTS is tested.

- In order to use the development version from Pluto's git repository, automatic build system tools, including `autoconf`, `automake`, and `libtool` are needed.

- LLVM/Clang 14.x (14.x recommended, 11.x, 12.x tested to work as well), along with its development/header files, is needed for the pet submodule. **For this forked copy, `Clang 16.0.6` & `Clang 15.0.0` is also tested successfully.**

- **DONOT WORK w/ THE `master` BRANCH.**

- For a **QUICKSTART**, go to [doc/helper-docs/QUICKSTART-SETUP-and-WORK-with-PLUTO.md](QUICKSTART-SETUP-and-WORK-with-PLUTO.md). **THAT DOCUMENT WILL TELL YOU THE `SUMMARIZED` PROCESS OF PLAYING WITH PLUTO.**


### 1.1. Installing Dev dependencies

**Idea:**
- General build tools `build-essential` (contains [multiple packages](https://packages.ubuntu.com/focal/build-essential) `g++`, `gcc`, `make`, `libc6-dev`, `dpkg-dev`)
- Automatic build tools including `autoconf`, `automake`, and `libtool`.
- `libgmp3-dev` that is required by `cloog-isl` lib.
- `flex` and `bison` for `clan` that Pluto depends on.
- `texinfo`, `texlive`, `texlive-latex-extra`, `texlive-science` used to generate some docs.

**What + How to install:**
- General dev dependencies:
```sh
sudo apt-get install -y build-essential flex bison xutils-dev zlib1g-dev libglu1-mesa-dev
```

- Pluto specific dependencies:
```sh
sudo apt-get install -y libgmp3-dev automake autoconf libtool libtool-bin pkg-config
```

- To avoid errors for generating PDF docs from `cloog-isl` (Check [Issue 98](https://github.com/bondhugula/pluto/issues/98) )
```sh
sudo apt-get install -y texinfo texlive texlive-latex-extra texlive-science
```


### 1.2. Handling `LLVM/Clang` dependency

- **`Clang` should be built (not installed with `apt-get install`)**. Because we consider that you might have other `Clang` versions in your machine.

- We will be passing path of `Clang` using the `--with-clang-prefix=$CLANG_BUILD_PATH` in pluto's `configure` command.

- Make sure of that, the `Clang` lib path is added to your `LD_LIBRARY_PATH` after your build the `Clang`.

- **Clone `Clang 16.0.6` `git clone -b release/16.x --depth 1 https://github.com/llvm/llvm-project.git llvm-16-src-build`**

- **Build Clang with `clang` + `clang++` (faster)**. Clone the `llvm-16.0.6`, then use following

```sh
mkdir -p build installation
cd build/
echo $PWD
cmake   \
    -G Ninja    \
    -S ../llvm  \
    -B .    \
    -DCMAKE_BUILD_TYPE=Release      \
    -DCMAKE_INSTALL_PREFIX=../installation  \
    -DLLVM_ENABLE_ASSERTIONS=ON     \
    -DLLVM_ENABLE_PROJECTS="mlir;clang;lldb;lld" \
    -DLLVM_INSTALL_UTILS=ON     \
    -DLLVM_ENABLE_LLD=ON    \
    -DCMAKE_C_COMPILER=clang    \
    -DCMAKE_CXX_COMPILER=clang++    \
    -DLLVM_PARALLEL_LINK_JOBS=1     \
    -DLLVM_TARGETS_TO_BUILD="Native"

cmake --build . --target check-mlir
ninja install
```

- **Build Clang with `gcc` + `g++` (slower)**.
```sh
mkdir -p build installation
cd build/

echo $PWD

cmake   \
    -G Ninja    \
    -S ../llvm  \
    -B .    \
    -DCMAKE_BUILD_TYPE=Release      \
    -DCMAKE_INSTALL_PREFIX=../installation  \
    -DLLVM_ENABLE_ASSERTIONS=ON     \
    -DLLVM_ENABLE_PROJECTS="mlir;clang;lldb;lld" \
    -DLLVM_INSTALL_UTILS=ON     \
    -DLLVM_ENABLE_LLD=OFF    \
    -DCMAKE_C_COMPILER=gcc    \
    -DCMAKE_CXX_COMPILER=g++    \
    -DLLVM_PARALLEL_LINK_JOBS=0     \
    -DLLVM_TARGETS_TO_BUILD="Native"

cmake --build . --target check-mlir
ninja install
```



- **If `Clang 16` is configured in your `~/.bashrc` or `~/.profile` like following**

```sh
export LLVM_FOLDER_NAME="llvm-16-src-build"
export YOUR_LLVM_PROJECT_CLONE_PATH="/abs/path/to/$LLVM_FOLDER_NAME"
export LLVM_PROJECT_ROOT=$YOUR_LLVM_PROJECT_CLONE_PATH
export LLVM_INSTALLATION_ROOT=$LLVM_PROJECT_ROOT/installation

export LLVM_CONFIG="$LLVM_INSTALLATION_ROOT/bin/llvm-config"
export LLVM_AND_CLANG_BIN_PATH="$LLVM_INSTALLATION_ROOT/bin"
export LLVM_AND_CLANG_LIB_PATH="$LLVM_INSTALLATION_ROOT/lib"
export LLVM_AND_CLANG_INCLUDE_PATH="$LLVM_INSTALLATION_ROOT/include"
export LD_LIBRARY_PATH=$LLVM_AND_CLANG_LIB_PATH${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
export PATH=$LLVM_AND_CLANG_BIN_PATH${PATH:+:${PATH}}
```

- **If you want to use other `Clang` (e.g. `llvm 15.0.0`) for pluto, even you already have another `Clang` (e.g. `llvm 16.0.6`) configured in your `~/.bashrc` or `~/.profile`**
Assume you have already `llvm 16.0.6` build & configured in `~/.profile`. Now you want use another `llvm` version (e.g. `llvm 15.0.0` setup in ) for `pet` in pluto.
Then push the following snippet in your `~/.profile`. If you donot do this, when you run `./installation/bin/polycc input_code.c`, you will get error like `/path/build/tool/pluto: error while loading shared libraries: libclang-cpp.so.15git: cannot open shared object file: No such file or directory`

```sh
# Already defined config for llvm 16.0.6
export LLVM_FOLDER_NAME="llvm-16-src-build"
#.....
#....

# ADD THE FOLLOWINGs for llvm 15.0.0
LLVM_FOR_PET_INSTALLATION_ROOT=/abs/path/to/your/llvm-15-src-build/installation
LLVM_FOR_PET_LIB_PATH=$LLVM_FOR_PET_INSTALLATION_ROOT/lib
export LD_LIBRARY_PATH=$LLVM_FOR_PET_LIB_PATH${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
```



## 2. Installing Pluto

### 2.1. `clone` Pluto and `checkout` the branch `how-to-setup-pluto`

- **Donot use `--recursive`**.

```sh
git clone https://github.com/pal-stdr/pluto-forked.git pluto-with-llvm-16
```

- Checkout the branch `how-to-setup-pluto`
- **Donot work w/ the `master` branch.**

```sh
git checkout how-to-setup-pluto
```

### 2.2. Get all the submodules (i.e. `openscop`, `cloog-isl`, etc.)

```sh
# For loading other libs (cloog-isl, openscop, etc.) nested inside pluto (In one command)
git submodule update --init

# If you want to do it in 2 separate command
git submodule init
git submodule update
```


### 2.3. Run the `autogen.sh` to generate `configure` script for each of the submodule

```sh
./autogen.sh
```



### 2.4. Collect your `--with-clang-prefix=` path for Pluto

Considering the first example `Clang` setup in `~/.profile`, let's assume, the path is `/path/to/your/llvm-16-src-build/installation` or `/path/to/your/llvm-16-src-build/build`.



### 2.5. Prepare the following `shell` script for installing Pluto

- We assume, you have chosen the forked copy for cloning. The following `shell` can be found here []()

- Please run `build-pluto-with-llvm.sh` from the root of Pluto.

**How this shell works?**
1. It checks if you want to do `configure + make` or only `make`. This options are handy if you donot change your respective `configure.ac` and `Makefile.am` from different libs.
2. While `make` runs, it builds in separate `build/` dir in the pluto root. Keeps the code clean. You can change the dir name/path.
3. `make install` ensures you have the final build assets in separate `installation/` dir w.r.t pluto root pointed by `--prefix` path in `configure` command. You can change the dir name/path.
4. `pet` lib inside pluto expects `Clang`. The `build` or `prefix` path of `Clang` should be passed in `LLVM_FOR_PET_INSTALLATION_ROOT` shell var in the script. **SUPER MANDATORY**.

```sh
#!/bin/bash

# IF YOU WANT TO BUILD ONLY, SET IT TO 0
# IF YOU WANT TO CONFIGURE + BUILD, THEN SET IT TO 1
WANT_TO_CONFIGURE_AND_BUILD=1


# DONOT CHANGE IT.
# If you set "WANT_TO_CONFIGURE_AND_BUILD" to "1", by default "WANT_TO_BUILD_ONLY" will be set to "1"
WANT_TO_BUILD_ONLY=$([ $WANT_TO_CONFIGURE_AND_BUILD -eq 0 ] && echo 1 || echo 0)




# Setup the Clang dependency ENV vars for pet (MANDATORY)
# "LLVM_FOR_PET_INSTALLATION_ROOT" set this to LLVM 16 build or installation path
LLVM_FOR_PET_INSTALLATION_ROOT=/path/to/your/llvm-16-src-build/installation

# If you already have another Clang version in your machine, and you are using another "clang" version, you need to keep this part.
LLVM_FOR_PET_LIB_PATH=$LLVM_FOR_PET_INSTALLATION_ROOT/lib
export LD_LIBRARY_PATH=$LLVM_FOR_PET_LIB_PATH${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}




# Name of the folder where you want to build
# This keeps the Pluto src tree much clean
BUILD_DIR="build/"


# Name of the folder, Where you want to install the bins
# By default, this will be passed as "../configure --prefix=pluto/installation ...."
# Name of the dir relative to pluto
INSTALLATION_DIR="installation/"



# Pluto Configure flags
# If you want to use cache, use "-C"
CONFIGURE_FLAGS="--enable-static"



# Set the absolute path for the pluto's "./configure --prefix=$INSTALL_PREFIX" option
# You can change it if you want.
INSTALL_PREFIX=$PWD/$INSTALLATION_DIR


# The LLVM build location
# Change according to your Clang location. Should be absolute path
CLANG_INSTALL_PATH=$LLVM_FOR_PET_INSTALLATION_ROOT





# Handle the build dir
remove_build_dir() {
    if [ -d $BUILD_DIR ]; then
        echo "$BUILD_DIR exists. Deleting..."
        rm -R $BUILD_DIR
        echo "$BUILD_DIR Creating..."
        mkdir -p $BUILD_DIR
    else
        echo "$BUILD_DIR directory does not exist. Creating $BUILD_DIR .."
        mkdir -p $BUILD_DIR
    fi
}


# Handle the install dir
remove_install_dir() {
    if [ -d $INSTALL_PREFIX ]; then
        echo "$INSTALL_PREFIX exists. Deleting..."
        rm -R $INSTALL_PREFIX
        echo "$INSTALL_PREFIX Creating..."
        mkdir -p $INSTALL_PREFIX
    else
        echo "$INSTALL_PREFIX directory does not exist. Creating $INSTALL_PREFIX .."
        mkdir -p $INSTALL_PREFIX
    fi
}



if [ $WANT_TO_BUILD_ONLY -eq 1 ]; then
    echo "You have set 'WANT_TO_BUILD_ONLY' as TRUE."
    echo "$BUILD_DIR will not be deleted."
    echo "$INSTALL_PREFIX will be deleted and created again."
    remove_install_dir
    # Change to build/ dir
    cd $BUILD_DIR
    make -j$(nproc)
    make install
else
    echo "You have set 'WANT_TO_BUILD_ONLY' as FALSE."
    echo "$BUILD_DIR will be deleted and created again."
    echo "$INSTALL_PREFIX will also be deleted and created again."
    remove_build_dir
    remove_install_dir
    # Change to build/ dir
    cd $BUILD_DIR
    ../configure --prefix=$INSTALL_PREFIX --with-clang-prefix=$CLANG_INSTALL_PATH $CONFIGURE_FLAGS
    make -j$(nproc)
    make install
fi


# Key commands that are running

# Change to build/ dir
# cd $BUILD_DIR

# Idea of configure command
# ../configure --prefix=$MY_EXTERNAL_SDD_WORK_DIR/compiler-projects/all-pluto-test/pluto-with-llvm-16/installation --with-clang-prefix=$MY_EXTERNAL_SDD_WORK_DIR/compiler-projects/llvm-src-build/installation --enable-static

# If you want to use cache
# ../configure -C --prefix=$INSTALL_PREFIX --with-clang-prefix=$CLANG_INSTALL_PATH $CONFIGURE_FLAGS

# ../configure --prefix=$INSTALL_PREFIX --with-clang-prefix=$CLANG_INSTALL_PATH $CONFIGURE_FLAGS

# make -j$(nproc)

# make install
```

### 2.6. Update the `build-pluto-with-llvm.sh` with proper `WANT_TO_CONFIGURE_AND_BUILD=1` settings

**IMPORTANT:**
- **FOR THE `VERY FIRST TIME`, YOU HAVE TO RUN IT WITH `WANT_TO_CONFIGURE_AND_BUILD=1`. Means, it will gen `Makefile` by reading `configure` files from each submodules. And then run the actual build process (i.e. compilation).**

```sh
# One time
chmod +x build-pluto-with-llvm.sh

# Then run (w/ WANT_TO_CONFIGURE_AND_BUILD=1)
./build-pluto-with-llvm.sh
```

### 2.7. Play with Pluto ðŸ¤ 

- **I assume, you already configured + build Pluto once w/ `WANT_TO_CONFIGURE_AND_BUILD=1`.**
- **So now set it to `WANT_TO_CONFIGURE_AND_BUILD=0`. This will make sure that you only compile Pluto after changing the actual code each time. ðŸ˜‡**

```sh
# WANT_TO_CONFIGURE_AND_BUILD=0
# Just change Pluto code and Run the script again and again only to compile
./build-pluto-with-llvm.sh
```




## 3. How to use `Pluto`

Though the `--prefix=` is set to `pluto/installation`, so the bins can be found in `./installation/bin/` dir

### 3.1. Using `pluto` bin

- Usage format `installation/bin/pluto <input.c> [options] -o <output.c>`. Example `./installation/bin/pluto test/matmul.c -o test/transformed_matmul.c`


### 3.2. Using generated `polycc` script bin (`installation/bin/polycc`)

- Usage format `installation/bin/polycc <input.c> [options] -o <output.c>`. Example `./installation/bin/polycc test/matmul.c -o test/transformed_matmul.c`

- Remember `polycc` is shell script which act as a wrapper around `pluto`. It handles the optimization flags/options for this pluto release.

- Actually this `polycc` points to `build/tool/pluto`. **So if you want to use `polycc`, you cannot delete the `build/` dir**. Neither you will get error like `/pluto/build/tool/pluto: No such file or directory`. See the following snippet collected from inside of the `polycc`

```sh
pluto=/path/to/pluto/build/tool/pluto
inscop=/path/to/pluto-test-v2/build/../inscop

# check for command-line options
for arg in $*; do
    if [ $arg == "--parallel" ]; then
        PARALLEL=1
    elif [ $arg == "--parallelize" ]; then
        PARALLEL=1
    elif [ $arg == "--unroll" ]; then
        UNROLL=1
    elif [ $arg == "--debug" ]; then
        DEBUG=1
    elif [ $arg == "--moredebug" ]; then
        DEBUG=1
    elif [ $arg == "-i" ]; then
        INDENT=1
    elif [ $arg == "--indent" ]; then
        INDENT=1
    elif [ $arg == "--silent" ]; then
        SILENT=1
    fi
done

```

### Some of the `flags` for `pluto`

- Default for this `0.12.0-2-g655ca80` version (for details check [ChangeLog](ChangeLog))

```sh
- Introduced loop unroll and jam support using ClooG AST and enable it by
  default.
- Improvements to intra-tile optimization heuristics.
- Support for the LP based decoupled framework, Pluto-lp-dfp, included;
  requires Pluto to be configured with GLPK or Gurobi.
- Two more fusion models, namely, typed and hybrid fusion incorporated. These
  models use the decoupled framework work.
- libpluto interface updated.
- --tile and --parallel enabled by default
- Diamond tiling enabled by default
- Auto-indentifucation of time-iterated stencils with concurrent start.
- Code modernized for compilation with C++ compilers; language changed to C99
  and C++11 for all future development
- src/ split into lib/ and tool/ to separate out libpluto and the pluto tool.
```

- Available `Optimization` flags

```sh

Optimizations          Options related to optimization
       --tile                    Tile for locality [disabled by default]
       --[no]intratileopt        Optimize intra-tile execution order for locality [enabled by default]
       --second-level-tile       Tile a second time (typically for L2 cache) [disabled by default] 
       --determine-tile-size    Choose tile sizes using a tile size selection model
       --cache-size=<value>    Cache size per core in bytes for first level of tiling. Default 1MB (L2 cache size))
       --data-element-size=<value>  Size of each data element in bytes. Default sizeof(double)
       --parallel                Automatically parallelize (generate OpenMP pragmas) [disabled by default]
    or --parallelize
       --[no]diamond-tile        Performs diamond tiling (enabled by default)
       --full-diamond-tile       Enables full-dimensional concurrent start
       --per-cc-obj              Enables separate dependence distance upper bounds for dependences from different connected components
       --[no]prevector           Mark loops for (icc/gcc) vectorization (enabled by default)
       --multipar                Extract all degrees of parallelism [disabled by default];
                                    by default one degree is extracted within any schedule sub-tree (if it exists)
       --innerpar                Choose pure inner parallelism over pipelined/wavefront parallelism [disabled by default]

   Fusion                Options to control fusion heuristic
       --nofuse                  Do not fuse across SCCs of data dependence graph
       --maxfuse                 Maximal fusion
       --smartfuse [default]     Heuristic (in between nofuse and maxfuse)
       --typedfuse               Typed fusion. Fuses SCCs only when there is no loss of parallelism [uses dfp framework and requires glpk or gurobi for solving LPs]
       --hybridfuse              Typed fusion at outer levels and max fuse at inner level [uses dfp framework and requires glpk or gurobi for solving LPs]
       --delayedcut              Delays the cut between SCCs of different dimensionalities in dfp approach [uses glpk or gurobi for solving LPs]
```




